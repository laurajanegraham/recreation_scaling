---
title: "Download and process Flickr data"
output: github_document
bibliography: C:/Users/lg1u16/DATA/BIBLIOGRAPHY/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load_packages}
# Libraries
library(raster)
library(tidyverse)
library(knitr)
library(sf)
library(flickr)
library(lubridate)
```


## Flickr photo data

There are a couple of options. 

1. The approach used by InVEST [@Wood2013g], where all 'photo user days' are included. I worry that this will include a lot of non-recreational photos and bias the results towards cities, although their paper found good correlation between photo user days and income from recreation (but this included non-natural rec). NB I also had difficulties getting the InVEST software to download images over a large area.  

2. An approach where photos are filtered using keywords in a number of languages [@VanZanten2014]. The keywords are included in the supplementary materials for this paper. We can use the in development [flickr](https://github.com/FrancescaMancini/FlickrAPI_EABhackathon) package for R, 

Start with option 2. 

I'm going to start with just England for the years 2009-2017 to be comparable to the MENE data. Will need to think about how to extract for all of Europe (WOE ID for Europe is 24865675). I'm just using the keyword `natur*` to account for a reasonable number of European languages. Will build up on this using the tested keywords [@VanZanten2014]. 


```{r get_photos}
photos <- photosSearch(year_range = c(2009, 2017),
                        text = 'natur*',
                        woe_id = 24865675)
                        
photos_sf <- photos %>% 
  select(long = as.numeric.longitude.,
         lat = as.numeric.latitude.,
         owner,
         datetaken) %>% 
  mutate(owner_date = paste(owner, date(datetaken), sep="_")) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  st_transform(crs = 3035)

photos_sp <- as(photos_sf, "Spatial")



# testing
photos <- photosSearch(year_range = c(2016, 2017),
                        text = 'natur*',
                        woe_id = 24865675)
	
```

We need to convert from points to raster at the 6 analysis resolutions. In order to do so, we want the unique owner date combinations. 

```{r photo_rasters}
# loop through the dem files to get rasters for the visits
fnames <- list.files("data/covariates", pattern = "dem_mean", full.names = TRUE)

for(f in fnames) {
  ras <- raster(f)
  rln <- res(ras)/1000
  fname <- paste0("data/response/flickr_", rln[1], "km.tif")
  rec_ras <- rasterize(photos_sp, 
                       ras, 
                       'owner_date', 
                       fun=function(x,...)length(unique(x)), 
                       filename = fname,
                       overwrite = TRUE)
}
```

## Session Info

```{r session_info}
session <- devtools::session_info()
session[[1]]
session[[2]] %>% kable
```