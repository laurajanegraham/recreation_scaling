---
title: "Process Covariate Data"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load_packages}
# Libraries
library(raster)
library(tidyverse)
library(gdalUtils)
library(doParallel)
library(knitr)

# Analysis resolutions
rln <- c(1, 2, 5, 10, 25, 50, 100)

# Calculate the number of cores
no_cores <- detectCores() - 1
```

## General details

We are creating a dataset of social-ecological covariates at a range of spatial resolutions: 1km, 5km, 10km, 25km, 50km, 100km. All data are open. 

## Elevation data

We use [EU-DEM v1.1](https://land.copernicus.eu/pan-european/satellite-derived-products/eu-dem/eu-dem-v1.1/view) at 100m resolution to calculate topographic variability at each resolution. Note that we are using a version that we previously aggregated (mean) to 100m resolution to reduce processing time. We may wish to revisit. 

```{r dem_data}
dem <- raster("~/DATA/PHYSICAL/elev/eu_dem_1.1/eudem_100m_aggregated.tif")
```

```{r dem_var}
# Initiate cluster
cl <- makeCluster(no_cores)
clusterExport(cl, c("dem"))
clusterEvalQ(cl, "raster")

# aggregate to each resolution
out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/dem_var_", x, "km.tif")
  raster::aggregate(dem, (x*1000)/100, 
            fun=var, 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

```{r dem_mean}
# Initiate cluster
cl <- makeCluster(no_cores)
clusterExport(cl, c("dem"))
clusterEvalQ(cl, "raster")

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/dem_mean_", x, "km.tif")
  raster::aggregate(dem, (x*1000)/100, 
            fun=mean, 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

## Land-cover data

We use [Corine Land Cover 2012](https://land.copernicus.eu/pan-european/corine-land-cover/clc-2012) at 100m resolution to calculate land-cover proportions and diversity at each resolution. 

```{r clc_data}
align_rasters(unaligned = "C:/Users/lg1u16/DATA/LULC/clc2012/g100_clc12_V18_5.tif", 
              reference = "C:/Users/lg1u16/DATA/PHYSICAL/elev/eu_dem_1.1/eudem_100m_aggregated.tif",
              dstfile = "data/covariates/clc_100m.tif",
              r = "mode",
              nThreads = "ALL_CPUS",
              overwrite = TRUE)
```

```{r clc_dataload}
clc <- raster("data/covariates/clc_100m.tif")
```

### Land-cover diversity

```{r clc_shei}
# Initiate cluster
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster", "grainchanger"))

# aggregate to each resolution
out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_shei_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) grainchanger::diversity(y, lc_class = 1:44), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

### Proportion of amenity land cover

- green urban areas (10)
- sport and leisure facilities (11)

```{r clc_amenity}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_amenity_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 10:11), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

### Proportion of agricultural land cover

- classes 12 to 21. This includes all land-cover types associated with agriculture regardless of intensity.

```{r clc_agri}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_agri_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 12:21), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

### Proportion of forested land cover

- agro-forestry areas (22)
- broad-leaved forest (23)
- coniferous forest (24)
- mixed forest (25)

```{r clc_forest}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_forest_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 22:25), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

### Proportion of other vegetated land covers

- natural grasslands (26)
- moors and heathland (27)
- sclerophyllous vegetation (28)
- transitional woodland-shrub (29)

```{r clc_veg}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster", "grainchanger"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_veg_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 26:29), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

### Proportion of wetland land covers

- inland marshes (35)
- peat bogs (36)
- salt marshes (37)
- salines (38)
- intertidal flats (39)

```{r clc_wetland}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster", "grainchanger"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_wetland_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 35:39), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```


### Proportion of water bodies

- water courses (40)
- water bodies (41)
- coastal lagoons (42)
- estuaries (43)
- sea and ocean (44)

```{r clc_water}
cl <- makeCluster(no_cores)
clusterExport(cl, c("clc"))
clusterEvalQ(cl, c("raster", "grainchanger"))

out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/clc_water_", x, "km.tif")
  raster::aggregate(clc, (x*1000)/100, 
            fun=function(y, ...) sum(y %in% 40:44), 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

## Population data

We use [Population density disaggregated with Corine land cover 2000](https://www.eea.europa.eu/data-and-maps/data/population-density-disaggregated-with-corine-land-cover-2000-2) at 100m resolution to calculate total population at each resolution. 

```{r pop_data, eval = FALSE}
align_rasters(unaligned = "C:/Users/lg1u16/DATA/SOCIAL/EEA_gridded_population/popu01clcv5.tif", 
                     reference = "C:/Users/lg1u16/DATA/PHYSICAL/elev/eu_dem_1.1/eudem_100m_aggregated.tif",
                     dstfile = "data/covariates/pop_100m.tif",
                     nThreads = "ALL_CPUS")
```

```{r pop_total}
pop <- raster("data/covariates/pop_100m.tif")

# Initiate cluster
cl <- makeCluster(no_cores)
clusterExport(cl, c("pop"))
clusterEvalQ(cl, "raster")

# aggregate to each resolution
out <- parLapply(cl, rln, function(x) {
  fname <- paste0("data/covariates/pop_", x, "km.tif")
  raster::aggregate(pop, (x*1000)/100, 
            fun=sum, 
            filename = fname,
            overwrite = TRUE)
})

stopCluster(cl)
```

## Session Info

```{r session_info}
session <- devtools::session_info()
session[[1]]
session[[2]] %>% kable
```