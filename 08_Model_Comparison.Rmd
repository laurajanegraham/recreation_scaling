---
title: "Model Comparison"
output: github_document
bibliography: C:/Users/lg1u16/DATA/BIBLIOGRAPHY/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load_packages}
library(MASS)
library(raster)
library(sf)
library(GGally)
library(broom)
library(MuMIn)
library(knitr)
library(tidyverse)

# resolutions
rlns <- c("1km", "5km", "10km", "25km", "50km", "100km")

# study extent (for now this is England, will need extending to Europe)
study_ext_sf <- st_read("~/DATA/ADMINISTRATIVE/gb_shapefile/GBR_adm1.shp", quiet = TRUE) %>% 
  filter(NAME_1 == "England") %>% 
  st_transform(crs = 3035)

study_ext <- as(study_ext_sf, "Spatial")
```

## Data collating

We're making one big dataframe of the response (Flickr photo locations) and covariates (proportion of non-built land covers, land-cover diversity, mean elevation, topographic variation and population density) at each of the analysis resolutions. 

```{r get_data}
get_df <- function(rln) {
  # list all files of specified resolution
  fnames <- list.files("data/response", pattern = paste0("_", rln), full.names = TRUE)
  
  #fnames <- fnames[!str_detect(fnames, "mene")]
  # stack them
  dat <- stack(fnames)
  
  # crop by study extent
  dat <- crop(dat, study_ext)
  
  # get into a dataframe
  df <- as.data.frame(dat, xy = TRUE) %>% 
    rename_all(funs(str_replace_all(., paste0("_", rln), ""))) %>% 
    na.omit %>% 
    mutate(resolution = rln)
  
  return(df)
}

# dataframe with obs for all data
df <- map_dfr(rlns, get_df) %>% 
  mutate(resolution = factor(resolution, 
                             levels = c("1km", 
                                        "5km", 
                                        "10km", 
                                        "25km", 
                                        "50km", 
                                        "100km")))
```

## Data comparison

How well does the Flickr data predict the MENE data, and where do they differ. 

```{r}
ggplot(df, aes(x = eng_flickr, y = mene)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~resolution, scale = "free")
```

Let's fit some linear models so we can look at the overall fit. 

```{r mene_flickr_mods}
fit_mod <- function(dat) {
  lm(mene ~ eng_flickr,
      data = dat)
}

mod <- df %>% 
  group_by(resolution) %>% 
  nest() %>% 
  mutate(mod = map(data, fit_mod),
         mod_glance = map(mod, glance),
         mod_resids = map(mod, function(x) x$residuals))

mod_r2 <- mod %>%
  select(resolution, mod_glance) %>% 
  unnest() %>% 
  select(resolution, r.squared)
```

```{r}
ggplot(mod_r2, aes(x = resolution, y = r.squared, group = 1)) + 
  geom_point() + 
  stat_summary(fun.y=sum, geom="line")
```

This is a really similar pattern to both the flickr and mene models. I think this tells us more about how $R^2$ improves as resolution coarsens than anything else...

Fine resolution mene data picks out dog walkers, flickr data picks out "nice"/aesthetic etc. visits (perhaps holidays?)

- Chloe working on interspersion - viewsheds/gravity models

We can use the residuals to look at where the data sources differ.  

```{r, fig.width = 15, fig.height = 10}
resids <- mod %>% 
  select(resolution, data, mod_resids) %>% 
  unnest()

ggplot() + 
  geom_raster(data = mod_resids, 
              aes(x = x, y = y, fill = diff)) + 
  geom_sf(data = study_ext_sf, fill = NA) + 
  facet_wrap(~resolution) + 
  scale_fill_gradient2("Residuals") + 
  theme(axis.title = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

Negative residuals show us areas which are over-represented by MENE records, negative residuals show us areas that are over-represented by Flickr records. More areas over-represented by Flickr at all resolutions. 

## References

## Session Info

```{r session_info}
session <- devtools::session_info()
session[[1]]
session[[2]] %>% kable
```