---
title: "Model Comparison"
output: github_document
bibliography: C:/Users/lg1u16/DATA/BIBLIOGRAPHY/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r load_packages}
library(MASS)
library(raster)
library(sf)
library(GGally)
library(broom)
library(MuMIn)
library(knitr)
library(tidyverse)

# resolutions
rlns <- c("1km", "5km", "10km", "25km", "50km", "100km")

# study extent (for now this is England, will need extending to Europe)
study_ext_sf <- st_read("~/DATA/ADMINISTRATIVE/gb_shapefile/GBR_adm1.shp", quiet = TRUE) %>% 
  filter(NAME_1 == "England") %>% 
  st_transform(crs = 3035)

study_ext <- as(study_ext_sf, "Spatial")
```

## Data collating

We're making one big dataframe of the response (Flickr photo locations) and covariates (proportion of non-built land covers, land-cover diversity, mean elevation, topographic variation and population density) at each of the analysis resolutions. 

```{r get_data}
get_df <- function(rln) {
  # list all files of specified resolution
  fnames <- list.files("data/response", pattern = paste0("_", rln), full.names = TRUE)
  
  #fnames <- fnames[!str_detect(fnames, "mene")]
  # stack them
  dat <- stack(fnames)
  
  # crop by study extent
  dat <- crop(dat, study_ext)
  
  # get into a dataframe
  df <- as.data.frame(dat, xy = TRUE) %>% 
    rename_all(funs(str_replace_all(., paste0("_", rln), ""))) %>% 
    na.omit %>% 
    mutate(resolution = rln)
  
  return(df)
}

# dataframe with obs for all data
df <- map_dfr(rlns, get_df) %>% 
  mutate(resolution = factor(resolution, 
                             levels = c("1km", 
                                        "5km", 
                                        "10km", 
                                        "25km", 
                                        "50km", 
                                        "100km")))
```

## Data comparison

How well does the Flickr data predict the MENE data, and where do they differ. 

```{r}
ggplot(df, aes(x = eng_flickr, y = mene)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~resolution, scale = "free")
```

Let's fit some linear models so we can look at the overall fit. 

```{r mene_flickr_mods}
fit_mod <- function(dat) {
  lm(mene ~ eng_flickr,
      data = dat)
}

mod <- df %>% 
  group_by(resolution) %>% 
  nest() %>% 
  mutate(mod = map(data, fit_mod),
         mod_glance = map(mod, glance),
         mod_fitted = map(mod, fitted))

mod_r2 <- mod %>%
  select(resolution, mod_glance) %>% 
  unnest() %>% 
  select(resolution, r.squared)
```

```{r}
ggplot(mod_r2, aes(x = resolution, y = r.squared, group = 1)) + 
  geom_point() + 
  stat_summary(fun.y=sum, geom="line")
```

This is a really similar pattern to both the flickr and mene models. I think this tells us more about how $R^2$ improves as resolution coarsens than anything else...

We can look at bright and dark spots here too. 

```{r, fig.width = 15, fig.height = 10}
bd_spots <- mod %>% 
  select(resolution, data, mod_fitted) %>% 
  unnest() %>% 
  group_by(resolution) %>% 
  mutate(diff = mod_fitted - mene,
         bd_spots = case_when(diff < -sd(mene) ~ "Dark",
                               diff > sd(mene) ~ "Bright",
                               TRUE ~ "Neutral"))

# potentially explanatory spatial layers
# np <- st_read("~/DATA/ADMINISTRATIVE/national_parks_england/National_Parks_England.shp",
#               quiet = TRUE) %>%
#   st_transform(st_crs(study_ext_sf))
# 
# aonb <- st_read("~/DATA/ADMINISTRATIVE/aonb_england/Areas_of_Outstanding_Natural_Beauty_England.shp",
#                 quiet = TRUE) %>%
#   st_transform(st_crs(study_ext_sf))

cities <- st_read("~/DATA/ADMINISTRATIVE/uk_cities/Major_Towns_and_Cities_December_2015_Boundaries.shp",
                  quiet = TRUE) %>%
  st_transform(st_crs(study_ext_sf)) %>%
  st_centroid %>%
  filter(tcity15nm %in% c("Birmingham", "Leeds", "London", "Manchester", "Newcastle upon Tyne"))

ggplot() + 
  geom_raster(data = bd_spots, 
              aes(x = x, y = y, fill = bd_spots)) + 
  #geom_sf(data = np, colour = "black", fill = NA) + 
  #geom_sf(data = aonb, colour = "black", fill = NA) + 
  geom_sf(data = cities, colour = "black", fill = NA) + 
  geom_sf(data = study_ext_sf, fill = NA) + 
  facet_wrap(~resolution) + 
  scale_fill_manual(values = c("orange", "blue", "grey")) + 
  theme(axis.title = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

Bright spots show us areas which are over-represented by MENE records, dark spots show us areas that are over-represented by Flickr records. More areas over-represented by Flickr at all resolutions. 
## References

## Session Info

```{r session_info}
session <- devtools::session_info()
session[[1]]
session[[2]] %>% kable
```